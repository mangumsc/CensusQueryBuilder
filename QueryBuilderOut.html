<!DOCTYPE html>
<meta charset="utf-8">

<head>
  <title>Output</title>
  <link rel="icon" type="image/png" href="favicon.ico"/>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.7/angular.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"> </script>
  <link href="QueryBuilder.css" rel="stylesheet" type="text/css"/>
</head>

<body>

<h1>Census API Query Builder</h1>

<h2>Query:</h2> <input id="queryval" type="text" size="200">
<br>
<button onclick="reload();">Reload</button>

<br><br>
<h2>Output:</h2>

<div id="loading"></div>

<div id="loaded" ng-app="Output" ng-controller="table">

  <a href='#' class="export" id="downloadCSV" style="display:none;">Download as CSV</a><br><br>

	<table id="outputTable">
		<tr>
			<th ng-repeat="x in query_head track by $index">{{x}}</th>
		</tr>
		<tr ng-repeat="body in query_body" ng-if="$index > 0">
			<td ng-repeat="col in col_num" >{{body[col]}}</td>
		</tr>
	</table>
	
</div>

<iframe id="Response" style="display:none;" height="60" width="1000"></iframe>

<div style="position: fixed; bottom: 3px; background-color: white;">
  Any Issues or Requested Improvements e-mail Stephen.C.Mangum@Census.gov
</div>

</body>

<script>


var app = angular.module("Output",[]);

  app.controller("table", function($scope,$http,$q) {

  	

  	$scope.col_num = [];
  	$scope.query = sessionStorage.getItem('query');
  	document.getElementById('queryval').value = $scope.query.replace('&key=86ef546139db8dddaff1b4a9562f9a902f2b60b0','');
    
  	 $http.get($scope.query).success(function(query){
          $scope.query_head = query[0];
          for(i=0;i<query[0].length;i++){
          	$scope.col_num.push(i);
          };
          $scope.query_body = query;
          document.getElementById('downloadCSV').style.display = 'inline';
          document.getElementById('loading').style.display = 'none';
          document.getElementById('loaded').style.display = 'inline';
      })
  	 	.error(function(){
  	 		Response = document.getElementById('Response');
  	 		Response.style.display = 'inline';
  	 		Response.src = $scope.query;
        document.getElementById('loading').style.display = 'none';
        document.getElementById('loaded').style.display = 'inline';
  	  });

       $scope.sortBy = function(propertyName) {
            $scope.reverse = ($scope.propertyName === propertyName) ? !$scope.reverse : true;
            $scope.propertyName = propertyName;
         };
  });

  function reload(){
  	sessionStorage.setItem('query', document.getElementById('queryval').value + '&key=86ef546139db8dddaff1b4a9562f9a902f2b60b0');
  	window.open("QueryBuilderOut.html","_self");
  };

  function exportTableToCSV($table, filename) {
          var $rows = $table.find('tr'),
              // Temporary delimiter characters unlikely to be typed by keyboard
              // This is to avoid accidentally splitting the actual contents
              tmpColDelim = String.fromCharCode(11), // vertical tab character
              tmpRowDelim = String.fromCharCode(0), // null character
              // actual delimiter characters for CSV format
              colDelim = '","',
              rowDelim = '"\r\n"',
              // Grab text from table into CSV formatted string
              csv = '"' + $rows.map(function (i, row) {
                  var $row = $(row),
                      $cols = $row.find('th, td');

                  return $cols.map(function (j, col) {
                      var $col = $(col),
                          text = $col.text();
                  
                      return text.replace(/"/g, '""'); // escape double quotes

                  }).get().join(tmpColDelim);

              }).get().join(tmpRowDelim)
                  .split(tmpRowDelim).join(rowDelim)
                  .split(tmpColDelim).join(colDelim) + '"',

              // Data URI
              csvData = 'data:application/csv;charset=utf-8,' + encodeURIComponent(csv);

          $(this)
              .attr({
              'download': filename,
                  'href': csvData,
                  'target': '_blank'
          });
      };

      // This must be a hyperlink
      $(".export").on('click', function (event) {
          // CSV
          exportTableToCSV.apply(this, [$('#outputTable'), 'APIOutput.csv']);
        });


</script>